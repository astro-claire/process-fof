
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stellar_rotation &#8212; process-fof 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for stellar_rotation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">h5py</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;../config&#39;</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;../modules&#39;</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">modules.fof_process</span> <span class="kn">import</span> <span class="n">dx_wrap</span><span class="p">,</span><span class="n">get_starGroups</span><span class="p">,</span> <span class="n">get_gasIDgroups</span><span class="p">,</span> <span class="n">set_snap_directories</span><span class="p">,</span> <span class="n">open_hdf5</span><span class="p">,</span> <span class="n">get_headerprops</span><span class="p">,</span> <span class="n">set_subfind_catalog</span><span class="p">,</span> <span class="n">set_config</span><span class="p">,</span><span class="n">get_gasGroups</span><span class="p">,</span> <span class="n">get_cosmo_props</span><span class="p">,</span><span class="n">get_starIDgroups</span><span class="p">,</span> <span class="n">get_Halos</span>
<span class="kn">from</span> <span class="nn">modules.boundedness</span> <span class="kn">import</span> <span class="n">get_GroupPos</span><span class="p">,</span><span class="n">get_GroupRadii</span><span class="p">,</span><span class="n">get_GroupVel</span><span class="p">,</span> <span class="n">get_starIDs</span>
<span class="kn">import</span> <span class="nn">config.configuration</span> <span class="k">as</span> <span class="nn">config</span>

<span class="c1">#Set units and parameters</span>
<span class="n">constants</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">load_constants</span><span class="p">()</span>
<span class="n">UnitMass_in_g</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;UnitMass_in_g&#39;</span><span class="p">]</span>     
<span class="n">UnitLength_in_cm</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;UnitLength_in_cm&#39;</span><span class="p">]</span>
<span class="n">hubbleparam</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;hubbleparam&#39;</span><span class="p">]</span> <span class="c1">#hubble constant</span>
<span class="n">GRAVITY_cgs</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;GRAVITY_cgs&#39;</span><span class="p">]</span>
<span class="n">UnitVelocity_in_cm_per_s</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;UnitVelocity_in_cm_per_s&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="get_gasIDs"><a class="viewcode-back" href="../stellar_rotation.html#stellar_rotation.get_gasIDs">[docs]</a><span class="k">def</span> <span class="nf">get_gasIDs</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Get particle IDs (groupordered snap)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">allGasIDs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;PartType0/ParticleIDs&#39;</span><span class="p">]</span>
	<span class="n">allGasMasses</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;PartType0/Masses&#39;</span><span class="p">]</span>
	<span class="n">allGasVelocities</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;PartType0/Velocities&#39;</span><span class="p">]</span>
	<span class="n">allGasPositions</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;PartType0/Coordinates&#39;</span><span class="p">]</span>

	<span class="k">return</span> <span class="n">allGasIDs</span><span class="p">,</span><span class="n">allGasMasses</span><span class="p">,</span> <span class="n">allGasPositions</span><span class="p">,</span> <span class="n">allGasVelocities</span></div>

<span class="c1">#functions to calculate various bulk rotational properties (they are weird for memory reasons)</span>
<span class="k">def</span> <span class="nf">calc_vrms</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span><span class="n">velmagstars</span><span class="p">,</span> <span class="n">starMass_inGroup</span> <span class="p">):</span>
     <span class="n">velmag2stars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">velmagstars</span><span class="p">])</span>
     <span class="n">vrms_argument</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">velmag2stars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">starMass_inGroup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">velmag2stars</span><span class="p">))])</span>
     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vrms_argument</span><span class="p">)</span><span class="o">/</span><span class="n">mtot</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_vrad</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span><span class="n">v_radscalari</span><span class="p">,</span> <span class="n">starMass_inGroup</span> <span class="p">):</span>
    <span class="n">vrad_argument</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v_radscalari</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">starMass_inGroup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_radscalari</span><span class="p">))])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vrad_argument</span><span class="p">)</span><span class="o">/</span><span class="n">mtot</span>

<span class="k">def</span> <span class="nf">calc_vrot</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span><span class="n">v_rotmagi</span><span class="p">,</span> <span class="n">starMass_inGroup</span> <span class="p">):</span>
     <span class="n">vrot_argument</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v_rotmagi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_rotmagi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">starMass_inGroup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_rotmagi</span><span class="p">))])</span>
     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vrot_argument</span><span class="p">)</span><span class="o">/</span><span class="n">mtot</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_vturb</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span> <span class="n">v_turbmagi</span><span class="p">,</span><span class="n">starMass_inGroup</span><span class="p">):</span>
     <span class="n">vturb_argument</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v_turbmagi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_turbmagi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">starMass_inGroup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_turbmagi</span><span class="p">))])</span>
     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vturb_argument</span><span class="p">)</span><span class="o">/</span><span class="n">mtot</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_iscalar</span><span class="p">(</span><span class="n">tempradstars</span><span class="p">,</span><span class="n">lunitvec</span><span class="p">,</span><span class="n">starMass_inGroup</span><span class="p">):</span>
     <span class="n">iscalar_cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">tempradstars</span><span class="p">,</span><span class="n">lunitvec</span><span class="p">)</span>
     <span class="n">iscalar_argument</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">iscalar_cross</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">starMass_inGroup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iscalar_cross</span><span class="p">))])</span>
     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">iscalar_argument</span><span class="p">)</span>

<div class="viewcode-block" id="calc_stellar_rotation"><a class="viewcode-back" href="../stellar_rotation.html#stellar_rotation.calc_stellar_rotation">[docs]</a><span class="k">def</span> <span class="nf">calc_stellar_rotation</span><span class="p">(</span><span class="n">starMass_inGroup</span><span class="p">,</span><span class="n">starVel_inGroup</span><span class="p">,</span><span class="n">starPos_inGroup</span><span class="p">,</span> <span class="n">groupPos</span><span class="p">,</span><span class="n">groupVelocity</span><span class="p">,</span><span class="n">boxSize</span><span class="p">,</span><span class="n">boxSizeVel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rotation curve of stellar component - 25 steps</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#setup the vectors</span>
    <span class="n">tempvelstars</span> <span class="o">=</span> <span class="n">dx_wrap</span><span class="p">(</span><span class="n">starVel_inGroup</span><span class="o">-</span><span class="n">groupVelocity</span><span class="p">,</span> <span class="n">boxSizeVel</span><span class="p">)</span> <span class="c1">#velocity wrt group velocity</span>
    <span class="n">velmagstars</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tempvelstars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1">#magnitude of velocity</span>
    <span class="n">tempradstars</span> <span class="o">=</span> <span class="n">dx_wrap</span><span class="p">(</span><span class="n">starPos_inGroup</span><span class="o">-</span><span class="n">groupPos</span><span class="p">,</span><span class="n">boxSize</span><span class="p">)</span> <span class="c1">#radius wrt group position</span>
    <span class="n">distances</span><span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tempradstars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rmagstars</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1">#magnitude of radius (distance)</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-2</span> <span class="c1">#introduce an error of 1e-2 cm to avoid runtime warnings </span>
    <span class="n">rmagstars</span><span class="p">[</span><span class="n">rmagstars</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span>
    <span class="n">runitstars</span> <span class="o">=</span> <span class="n">tempradstars</span> <span class="o">/</span> <span class="n">rmagstars</span> <span class="c1">#unit vector in direction of radius</span>

    <span class="c1">#Overall group quantities</span>
    <span class="n">lvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">tempradstars</span><span class="p">,</span><span class="n">tempvelstars</span><span class="p">)</span><span class="o">*</span><span class="n">starMass_inGroup</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#angular momentum</span>
    <span class="n">lmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lvec</span><span class="p">)</span> <span class="c1">#magnitude of angular momentum</span>
    <span class="n">lunitvec</span> <span class="o">=</span> <span class="n">lvec</span><span class="o">/</span> <span class="n">lmag</span> <span class="c1">#unit vector in direction of L</span>
    <span class="c1">#iscalar = np.sum(np.linalg.norm(np.cross(tempradstars,lunitvec),axis = 1)**2*starMass_inGroup[:,np.newaxis]) #moment of inertia</span>
    <span class="n">iscalar</span> <span class="o">=</span> <span class="n">calc_iscalar</span><span class="p">(</span><span class="n">tempradstars</span><span class="p">,</span> <span class="n">lunitvec</span><span class="p">,</span><span class="n">starMass_inGroup</span><span class="p">)</span>
    <span class="n">omegavec</span> <span class="o">=</span> <span class="n">lvec</span><span class="o">/</span><span class="n">iscalar</span>

    <span class="c1">#calculate more individual vectors </span>
    <span class="n">v_rotveci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">tempradstars</span><span class="p">,</span> <span class="n">omegavec</span><span class="p">)</span> <span class="c1">#rotational velocity</span>
    <span class="n">v_rotmagi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_rotveci</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1">#rotational velocity magnitude</span>
    <span class="n">v_radveci</span> <span class="o">=</span> <span class="n">runitstars</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">runitstars</span> <span class="o">*</span> <span class="n">tempvelstars</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1">#radial velocity</span>
    <span class="n">v_radscalari</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">runitstars</span> <span class="o">*</span> <span class="n">tempvelstars</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1">#radial velocity magnitude</span>
    <span class="n">v_turbveci</span> <span class="o">=</span> <span class="n">tempvelstars</span> <span class="o">-</span> <span class="n">v_rotveci</span> <span class="o">-</span> <span class="n">v_radveci</span> <span class="c1">#vector turbulent velocity</span>
    <span class="n">v_turbmagi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_turbveci</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1">#magnitude turbulent velocity</span>

    <span class="c1">#bulk velocities for the halo - doing this weirdly to get around memory limit problems with array multiplication</span>
    <span class="n">mtot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">starMass_inGroup</span><span class="p">)</span>
    <span class="c1">#total rms velocity</span>
    <span class="n">v_rmstot</span> <span class="o">=</span> <span class="n">calc_vrms</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span><span class="n">velmagstars</span><span class="p">,</span> <span class="n">starMass_inGroup</span><span class="p">)</span>
    <span class="c1">#total radial velocity</span>
    <span class="n">v_radtot</span> <span class="o">=</span> <span class="n">calc_vrad</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span><span class="n">v_radscalari</span><span class="p">,</span> <span class="n">starMass_inGroup</span> <span class="p">)</span>
    <span class="c1">#total rotational velocity</span>
    <span class="c1"># v_rottot = np.sqrt(np.sum(starMass_inGroup * (np.linalg.norm(v_rotveci, axis=1)[:,np.newaxis])**2)/mtot)</span>
    <span class="n">v_rottot</span> <span class="o">=</span> <span class="n">calc_vrot</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span><span class="n">v_rotmagi</span><span class="p">,</span><span class="n">starMass_inGroup</span><span class="p">)</span>
    <span class="c1">#turbulent velocity </span>
    <span class="n">v_turbtot</span> <span class="o">=</span> <span class="n">calc_vturb</span><span class="p">(</span><span class="n">mtot</span><span class="p">,</span> <span class="n">v_turbmagi</span><span class="p">,</span> <span class="n">starMass_inGroup</span><span class="p">)</span>

    <span class="c1">#Calculate velocity dispersion of galaxy</span>
    <span class="c1">#velDispStars = np.sqrt(np.sum((velMagStars - np.mean(velMagStars))**2))/np.size(velMagStars) #velocity dispersion of magnitudes (not projected along a LOS)</span>
    <span class="n">inner_rad</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rmagstars</span><span class="p">)</span>
    <span class="n">outer_rad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rmagstars</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">outer_rad</span><span class="o">-</span><span class="n">inner_rad</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">inner_rad</span>
    <span class="n">rotation_curve_rms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rotation_curve_rad</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rotation_curve_rot</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rotation_curve_turb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="n">outer_rad</span><span class="p">:</span>
         <span class="n">shell_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">distances</span><span class="o">&lt;</span><span class="n">radius</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shell_idx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#only use shells containing star particles</span>
            <span class="n">vel_inShell</span> <span class="o">=</span> <span class="n">velmagstars</span><span class="p">[</span><span class="n">shell_idx</span><span class="p">]</span>
            <span class="n">vel_rad_inShell</span> <span class="o">=</span> <span class="n">v_radscalari</span><span class="p">[</span><span class="n">shell_idx</span><span class="p">]</span>
            <span class="n">vel_rot_inShell</span> <span class="o">=</span> <span class="n">v_rotmagi</span><span class="p">[</span><span class="n">shell_idx</span><span class="p">]</span>
            <span class="n">vel_turb_inShell</span> <span class="o">=</span> <span class="n">v_turbmagi</span><span class="p">[</span><span class="n">shell_idx</span><span class="p">]</span>
            <span class="n">mass_inShell</span> <span class="o">=</span> <span class="n">starMass_inGroup</span><span class="p">[</span><span class="n">shell_idx</span><span class="p">]</span>
            <span class="n">mshell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_inShell</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">shell_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#Remove the used particles</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="c1">#next shell we&#39;ll only search the unused DM particles</span>
            <span class="n">velmagstars</span> <span class="o">=</span> <span class="n">velmagstars</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">v_radscalari</span> <span class="o">=</span> <span class="n">v_radscalari</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">v_rotmagi</span><span class="o">=</span><span class="n">v_rotmagi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">v_turbmagi</span><span class="o">=</span><span class="n">v_turbmagi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">starMass_inGroup</span> <span class="o">=</span> <span class="n">starMass_inGroup</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="c1">#velocity = sum(vel_inShell)/len(vel_inShell) #average velocity in shell</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="n">calc_vrms</span><span class="p">(</span><span class="n">mshell</span><span class="p">,</span><span class="n">vel_inShell</span><span class="p">,</span><span class="n">mass_inShell</span><span class="p">)</span>
            <span class="n">velocity_rad</span> <span class="o">=</span> <span class="n">calc_vrad</span><span class="p">(</span><span class="n">mshell</span><span class="p">,</span><span class="n">vel_rad_inShell</span><span class="p">,</span> <span class="n">mass_inShell</span> <span class="p">)</span>
            <span class="n">velocity_rot</span> <span class="o">=</span> <span class="n">calc_vrot</span><span class="p">(</span><span class="n">mshell</span><span class="p">,</span> <span class="n">vel_rot_inShell</span><span class="p">,</span><span class="n">mass_inShell</span><span class="p">)</span>
            <span class="n">velocity_turb</span> <span class="o">=</span> <span class="n">calc_vturb</span><span class="p">(</span><span class="n">mshell</span><span class="p">,</span> <span class="n">vel_turb_inShell</span><span class="p">,</span> <span class="n">mass_inShell</span><span class="p">)</span>
            <span class="n">rotation_curve_rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
            <span class="n">rotation_curve_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">velocity_rad</span><span class="p">)</span>
            <span class="n">rotation_curve_rot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">velocity_rot</span><span class="p">)</span>
            <span class="n">rotation_curve_turb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">velocity_turb</span><span class="p">)</span>
            <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span> 
              <span class="c1">#Case with empty shell</span>
              <span class="n">velocity</span> <span class="o">=</span> <span class="mf">0.</span>
         <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">step</span>
    <span class="k">return</span> <span class="n">rotation_curve_rms</span><span class="p">,</span><span class="n">rotation_curve_rad</span><span class="p">,</span><span class="n">rotation_curve_rot</span><span class="p">,</span> <span class="n">rotation_curve_turb</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="n">v_rmstot</span><span class="p">,</span><span class="n">v_radtot</span><span class="p">,</span><span class="n">v_rottot</span><span class="p">,</span> <span class="n">v_turbtot</span></div>
     

<div class="viewcode-block" id="iterate_galaxies"><a class="viewcode-back" href="../stellar_rotation.html#stellar_rotation.iterate_galaxies">[docs]</a><span class="k">def</span> <span class="nf">iterate_galaxies</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">boxSize</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">,</span> <span class="n">allStarMasses</span><span class="p">,</span> <span class="n">allStarPositions</span><span class="p">,</span><span class="n">allStarVelocities</span><span class="p">,</span> <span class="n">startAllStars</span><span class="p">,</span><span class="n">endAllStars</span><span class="p">,</span> <span class="n">groupRadii</span><span class="p">,</span><span class="n">groupPos</span><span class="p">,</span> <span class="n">groupVelocities</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    iterate all the galaxies in the FOF and find their rotation curves.</span>
<span class="sd">    Perform all the unit conversions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hubbleparam</span><span class="o">=</span> <span class="mf">0.71</span> <span class="c1">#FIX THESE SO THEY AREN&#39;T HARD CODED</span>
    <span class="n">Omega0</span> <span class="o">=</span> <span class="mf">0.27</span>
    <span class="n">OmegaLambda</span> <span class="o">=</span> <span class="mf">0.73</span>
    <span class="n">groupPos</span> <span class="o">=</span> <span class="n">groupPos</span> <span class="o">*</span><span class="n">atime</span> <span class="o">/</span> <span class="n">hubbleparam</span> 
    <span class="n">groupVelocities</span> <span class="o">=</span> <span class="n">groupVelocities</span>  <span class="o">/</span><span class="n">atime</span> <span class="c1"># convert to physical units</span>
    <span class="c1"># groupPos = groupPos * UnitLength_in_cm*atime / hubbleparam </span>
    <span class="c1"># groupVelocities = groupVelocities * UnitVelocity_in_cm_per_s /atime # convert to physical units</span>
    <span class="n">rotation_rms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rotation_rad</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rotation_rot</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rotation_turb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v_rms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v_rot</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v_rad</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v_turb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">avg_masses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ngroup</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#hubble flow correction</span>
    <span class="n">boxSizeVel</span> <span class="o">=</span> <span class="n">boxSize</span> <span class="o">*</span> <span class="n">hubbleparam</span> <span class="o">*</span> <span class="mf">.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Omega0</span><span class="o">/</span><span class="n">atime</span><span class="o">/</span><span class="n">atime</span><span class="o">/</span><span class="n">atime</span> <span class="o">+</span> <span class="n">OmegaLambda</span><span class="p">)</span>
    <span class="c1"># boxSizeVel = boxSize * UnitVelocity_in_cm_per_s* hubbleparam * .1 * np.sqrt(Omega0/atime/atime/atime + OmegaLambda)</span>
    <span class="c1"># boxSize = boxSize * UnitLength_in_cm* atime/hubbleparam</span>
    <span class="n">boxSize</span> <span class="o">=</span> <span class="n">boxSize</span> <span class="o">*</span> <span class="n">atime</span><span class="o">/</span><span class="n">hubbleparam</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">halo100_indices</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
        <span class="n">starPos_inGroup</span> <span class="o">=</span> <span class="n">allStarPositions</span><span class="p">[</span><span class="n">startAllStars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">endAllStars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">starVel_inGroup</span> <span class="o">=</span> <span class="n">allStarVelocities</span><span class="p">[</span><span class="n">startAllStars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">endAllStars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">starMass_inGroup</span> <span class="o">=</span> <span class="n">allStarMasses</span><span class="p">[</span><span class="n">startAllStars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">endAllStars</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">starMass_inGroup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">starMass_inGroup</span><span class="p">)</span>   <span class="o">/</span> <span class="n">hubbleparam</span> <span class="c1">#convert masses</span>
        <span class="n">starVel_inGroup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">starVel_inGroup</span><span class="p">)</span> <span class="o">*</span>  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">atime</span><span class="p">)</span> <span class="c1">#unit conversions on the particle coordinates </span>
        <span class="n">starPos_inGroup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">starPos_inGroup</span><span class="p">)</span> <span class="o">*</span> <span class="n">atime</span> <span class="o">/</span> <span class="n">hubbleparam</span>
        <span class="c1"># starMass_inGroup = np.array(starMass_inGroup)  * UnitMass_in_g / hubbleparam #convert masses</span>
        <span class="c1"># starVel_inGroup = np.array(starVel_inGroup) * UnitVelocity_in_cm_per_s * np.sqrt(atime) #unit conversions on the particle coordinates </span>
        <span class="c1"># starPos_inGroup = np.array(starPos_inGroup) *UnitLength_in_cm *atime / hubbleparam</span>
        <span class="n">rotation_curve_rms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rotation_curve_rad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rotation_curve_rot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rotation_curve_turb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rotation_radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v_rmstot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v_radtot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v_rottot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v_turbtot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_ingroup</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">starMass_inGroup</span><span class="p">)</span>
        <span class="n">avg_mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">n_ingroup</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> 
            <span class="n">avg_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">starMass_inGroup</span><span class="p">)</span>
            <span class="n">rotation_curve_rms</span><span class="p">,</span><span class="n">rotation_curve_rad</span><span class="p">,</span><span class="n">rotation_curve_rot</span><span class="p">,</span> <span class="n">rotation_curve_turb</span><span class="p">,</span><span class="n">rotation_radii</span><span class="p">,</span><span class="n">v_rmstot</span><span class="p">,</span><span class="n">v_radtot</span><span class="p">,</span><span class="n">v_rottot</span><span class="p">,</span> <span class="n">v_turbtot</span>  <span class="o">=</span> <span class="n">calc_stellar_rotation</span><span class="p">(</span><span class="n">starMass_inGroup</span><span class="p">,</span><span class="n">starVel_inGroup</span><span class="p">,</span><span class="n">starPos_inGroup</span><span class="p">,</span> <span class="n">groupPos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">groupVelocities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">boxSize</span><span class="p">,</span><span class="n">boxSizeVel</span><span class="p">)</span>
        <span class="n">rotation_rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotation_curve_rms</span><span class="p">)</span>
        <span class="n">rotation_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotation_curve_rad</span><span class="p">)</span>
        <span class="n">rotation_rot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotation_curve_rot</span><span class="p">)</span>
        <span class="n">rotation_turb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotation_curve_turb</span><span class="p">)</span>
        <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotation_radii</span><span class="p">)</span>
        <span class="n">v_rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_rmstot</span><span class="p">)</span>
        <span class="n">v_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_radtot</span><span class="p">)</span>
        <span class="n">v_rot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_rottot</span><span class="p">)</span>
        <span class="n">v_turb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_turbtot</span><span class="p">)</span>
        <span class="n">avg_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_mass</span><span class="p">)</span>
        <span class="n">ngroup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_ingroup</span><span class="p">)</span>
    <span class="c1"># objs[&#39;rot_curves&#39;] = np.array(rotation,dtype=object)</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;rot_radii&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="c1"># objs[&#39;vel_dispersion&#39;] = np.array(dispersions)</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;rotation_curve_rms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_rms</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;rotation_curve_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_rad</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;rotation_curve_rot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_rot</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;rotation_curve_turb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_turb</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;v_rms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_rms</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;v_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_rad</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;v_rot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_rot</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;v_turb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_turb</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;avg_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_masses</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;ngroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ngroup</span>
    <span class="k">return</span> <span class="n">objs</span></div>

<div class="viewcode-block" id="add_rotation_curves"><a class="viewcode-back" href="../stellar_rotation.html#stellar_rotation.add_rotation_curves">[docs]</a><span class="k">def</span> <span class="nf">add_rotation_curves</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;Stars&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    wrapper function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;opening files&#39;</span><span class="p">)</span>
    <span class="n">gofilename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">gofilename</span><span class="p">,</span> <span class="n">foffilename</span> <span class="o">=</span> <span class="n">set_snap_directories</span><span class="p">(</span><span class="n">gofilename</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">foffilename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gofilename</span><span class="p">))</span>
    <span class="n">snap</span><span class="p">,</span> <span class="n">fof</span> <span class="o">=</span> <span class="n">open_hdf5</span><span class="p">(</span><span class="n">gofilename</span><span class="p">,</span> <span class="n">foffilename</span><span class="p">)</span>
    <span class="n">boxSize</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_headerprops</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;redshift is &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">redshift</span><span class="p">))</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">set_subfind_catalog</span><span class="p">(</span><span class="n">fof</span><span class="p">)</span>
    <span class="n">prim</span><span class="p">,</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">set_config</span><span class="p">(</span><span class="n">fof</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I detected that the FOF has &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; primary and &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; secondary.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting fof groups&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;Stars&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;used groups of 100 or more stars&quot;</span><span class="p">)</span>
        <span class="n">halo100_indices</span><span class="o">=</span><span class="n">get_starGroups</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;Gas&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;used groups of 100 or more gas&quot;</span><span class="p">)</span>
        <span class="n">halo100_indices</span><span class="o">=</span><span class="n">get_gasGroups</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;DM&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;used groups of 300 or more DM!&quot;</span><span class="p">)</span>
        <span class="n">halo100_indices</span> <span class="o">=</span> <span class="n">get_Halos</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading star particles&quot;</span><span class="p">)</span>
    <span class="c1"># TESTING MODE: UNCOMMENT below!!</span>
    <span class="c1">#halo100_indices = halo100_indices[-20:-1]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">halo100_indices</span><span class="p">))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">allStarMasses</span><span class="p">,</span> <span class="n">allStarPositions</span><span class="p">,</span> <span class="n">allStarVelocities</span><span class="o">=</span> <span class="n">get_starIDs</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
    <span class="n">startAllStars</span><span class="p">,</span> <span class="n">endAllStars</span> <span class="o">=</span> <span class="n">get_starIDgroups</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">halo100_pos</span> <span class="o">=</span> <span class="n">get_GroupPos</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">halo100_rad</span> <span class="o">=</span> <span class="n">get_GroupRadii</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">halo100_vel</span> <span class="o">=</span> <span class="n">get_GroupVel</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span><span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">atime</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculating rotation curves for all objects&quot;</span><span class="p">)</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="n">iterate_galaxies</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">boxSize</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">,</span> <span class="n">allStarMasses</span><span class="p">,</span> <span class="n">allStarPositions</span><span class="p">,</span><span class="n">allStarVelocities</span><span class="p">,</span> <span class="n">startAllStars</span><span class="p">,</span><span class="n">endAllStars</span><span class="p">,</span> <span class="n">halo100_rad</span><span class="p">,</span><span class="n">halo100_pos</span><span class="p">,</span> <span class="n">halo100_vel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">objs</span></div>


<div class="viewcode-block" id="add_rotation_curves_gas"><a class="viewcode-back" href="../stellar_rotation.html#stellar_rotation.add_rotation_curves_gas">[docs]</a><span class="k">def</span> <span class="nf">add_rotation_curves_gas</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;Stars&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    wrapper function - gas verison!!!!!!!! calculates for gas!!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;opening files&#39;</span><span class="p">)</span>
    <span class="n">gofilename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">gofilename</span><span class="p">,</span> <span class="n">foffilename</span> <span class="o">=</span> <span class="n">set_snap_directories</span><span class="p">(</span><span class="n">gofilename</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">foffilename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gofilename</span><span class="p">))</span>
    <span class="n">snap</span><span class="p">,</span> <span class="n">fof</span> <span class="o">=</span> <span class="n">open_hdf5</span><span class="p">(</span><span class="n">gofilename</span><span class="p">,</span> <span class="n">foffilename</span><span class="p">)</span>
    <span class="n">boxSize</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_headerprops</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;redshift is &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">redshift</span><span class="p">))</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">set_subfind_catalog</span><span class="p">(</span><span class="n">fof</span><span class="p">)</span>
    <span class="n">prim</span><span class="p">,</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">set_config</span><span class="p">(</span><span class="n">fof</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I detected that the FOF has &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; primary and &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; secondary.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting fof groups&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;Stars&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;used groups of 100 or more stars&quot;</span><span class="p">)</span>
        <span class="n">halo100_indices</span><span class="o">=</span><span class="n">get_starGroups</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;Gas&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;used groups of 100 or more gas&quot;</span><span class="p">)</span>
        <span class="n">halo100_indices</span><span class="o">=</span><span class="n">get_gasGroups</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;DM&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;used groups of 300 or more DM!&quot;</span><span class="p">)</span>
        <span class="n">halo100_indices</span> <span class="o">=</span> <span class="n">get_Halos</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading star particles&quot;</span><span class="p">)</span>
    <span class="c1"># TESTING MODE: UNCOMMENT below!!</span>
    <span class="c1">#halo100_indices = halo100_indices[-20:-1]</span>
    <span class="n">_</span><span class="p">,</span><span class="n">allGasMasses</span><span class="p">,</span> <span class="n">allGasPositions</span><span class="p">,</span> <span class="n">allGasVelocities</span><span class="o">=</span> <span class="n">get_gasIDs</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
    <span class="n">startAllGas</span><span class="p">,</span> <span class="n">endAllGas</span> <span class="o">=</span> <span class="n">get_gasIDgroups</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">halo100_pos</span> <span class="o">=</span> <span class="n">get_GroupPos</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">halo100_rad</span> <span class="o">=</span> <span class="n">get_GroupRadii</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">halo100_vel</span> <span class="o">=</span> <span class="n">get_GroupVel</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span><span class="n">halo100_indices</span><span class="p">)</span>
    <span class="n">atime</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculating rotation curves for all objects&quot;</span><span class="p">)</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="n">iterate_galaxies</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">boxSize</span><span class="p">,</span> <span class="n">halo100_indices</span><span class="p">,</span> <span class="n">allGasMasses</span><span class="p">,</span><span class="n">allGasPositions</span><span class="p">,</span><span class="n">allGasVelocities</span><span class="p">,</span> <span class="n">startAllGas</span><span class="p">,</span><span class="n">endAllGas</span><span class="p">,</span> <span class="n">halo100_rad</span><span class="p">,</span><span class="n">halo100_pos</span><span class="p">,</span> <span class="n">halo100_vel</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">objs</span></div>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Routine if running as a script</span>

<span class="sd">    Arguments: </span>
<span class="sd">    gofilename path to directory containing groupordered file + fof table</span>
<span class="sd">    # foffilename </span>
<span class="sd">    snapnum (float)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">script</span><span class="p">,</span> <span class="n">gofilename</span><span class="p">,</span> <span class="n">snapnum</span> <span class="o">=</span> <span class="n">argv</span>
    <span class="c1"># with open(&quot;/home/x-cwilliams/FOF_calculations/newstars_Sig2_25Mpc.dat&quot;,&#39;rb&#39;) as f:</span>
    <span class="c1"># 	newstars = pickle.load(f,encoding = &quot;latin1&quot;)</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="n">add_rotation_curves</span><span class="p">(</span><span class="n">gofilename</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">)</span>
    <span class="c1"># with open(gofilename+&quot;/test_stellar_rotation_&quot;+str(snapnum)+&quot;_v2.dat&quot;,&#39;wb&#39;) as f:   </span>
    <span class="c1">#     pickle.dump(objs, f)</span>
    <span class="c1"># with open(&quot;/anvil/projects/x-ast180056/FOF_project/test_stellar_rotation_&quot;+str(snapnum)+&quot;_v2.dat&quot;,&#39;wb&#39;) as f:   </span>
    <span class="c1">#     pickle.dump(objs, f)</span>
    <span class="c1">#print(&quot;SAVED OUTPUT!&quot;)</span>




    <span class="c1"># velMagStars = np.sqrt((tempvelstars*tempvelstars).sum(axis=1))</span>
    <span class="c1"># print(velMagStars)</span>
    <span class="c1"># distances = dist2(starPos_inGroup[:,0]-groupPos[0],starPos_inGroup[:,1]-groupPos[1],starPos_inGroup[:,2]-groupPos[2],boxSize)</span>
    <span class="c1"># #Calculate velocity dispersion of galaxy</span>
    <span class="c1"># velDispStars = np.sqrt(np.sum((velMagStars - np.mean(velMagStars))**2))/np.size(velMagStars) #velocity dispersion of magnitudes (not projected along a LOS)</span>
    <span class="c1"># inner_rad = min(distances)</span>
    <span class="c1"># outer_rad = max(distances)</span>
    <span class="c1"># step = (outer_rad-inner_rad)/25</span>
    <span class="c1"># radius = inner_rad</span>
    <span class="c1"># rotation_curve = []</span>
    <span class="c1"># radii = []</span>
    <span class="c1"># while radius &lt; outer_rad:</span>
    <span class="c1">#      shell_idx = np.where(distances&lt;radius)[0]</span>
    <span class="c1">#      if len(shell_idx)&gt;0: #only use shells containing star particles</span>
    <span class="c1">#         vel_inShell = velMagStars[shell_idx]</span>
    <span class="c1">#         mask = np.ones(distances.shape, dtype=&#39;bool&#39;)</span>
    <span class="c1">#         mask[shell_idx] = False #Remove the used particles</span>
    <span class="c1">#         distances = distances[mask] #next shell we&#39;ll only search the unused DM particles</span>
    <span class="c1">#         velMagStars = velMagStars[mask]</span>
    <span class="c1">#         velocity = sum(vel_inShell)/len(vel_inShell) #average velocity in shell</span>
    <span class="c1">#         rotation_curve.append(velocity)</span>
    <span class="c1">#         radii.append(radius)</span>
    <span class="c1">#      else: </span>
    <span class="c1">#           #Case with empty shell</span>
    <span class="c1">#           velocity = 0.</span>
    <span class="c1">#      radius = radius + step</span>
    <span class="c1"># return rotation_curve, radii, velDispStars</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">process-fof</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fof_process.html">FOF Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundedness.html">Boundedness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stellar_rotation.html">Stellar Rotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concatenateclass.html">processedFOF Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environment.html">Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dm_virialization.html">DM virialization</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2024, Claire Williams.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>